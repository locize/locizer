!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.locizer=e()}(this,function(){"use strict";function t(t,e,n){var o;return function(){var i=this,r=arguments,a=function(){o=null,n||t.apply(i,r)},s=n&&!o;clearTimeout(o),o=setTimeout(a,e),s&&t.apply(i,r)}}function e(t,e,n){function o(t){return t&&t.indexOf("###")>-1?t.replace(/###/g,"."):t}for(var i="string"!=typeof e?[].concat(e):e.split(".");i.length>1;){if(!t)return{};var r=o(i.shift());!t[r]&&n&&(t[r]=new n),t=t[r]}return t?{obj:t,k:o(i.shift())}:{}}function n(t,n,o){var i=e(t,n,Object);i.obj[i.k]=o}function o(t,n,o,i){var r=e(t,n,Object),a=r.obj,s=r.k;a[s]=a[s]||[],i&&(a[s]=a[s].concat(o)),i||a[s].push(o)}function i(t,n){var o=e(t,n),i=o.obj,r=o.k;if(i)return i[r]}function r(t){return null==t?"":""+t}function a(t,e,n){for(var o=void 0,i=void 0;o=L.exec(t);)i=o[1].trim(),"string"!=typeof i&&(i=r(i)),i||(i=""),i=function(t){return t.replace(/\$/g,"$$$$")}(i),t=t.replace(o[0],e[i]||i),L.lastIndex=0;return t}function s(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function u(t,e,n,o,i){try{var r=new(XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");r.open(o?"POST":"GET",t,1),e.crossDomain||r.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.authorize&&e.apiKey&&r.setRequestHeader("Authorization",e.apiKey),(o||e.setContentTypeJSON)&&r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){r.readyState>3&&n&&n(r.responseText,r)},r.send(JSON.stringify(o))}catch(t){window.console&&console.log(t)}}function c(){return{loadPath:"https://api.locize.io/{{projectId}}/{{version}}/{{lng}}/{{ns}}",privatePath:"https://api.locize.io/private/{{projectId}}/{{version}}/{{lng}}/{{ns}}",pullPath:"https://api.locize.io/pull/{{projectId}}/{{version}}/{{lng}}/{{ns}}",getLanguagesPath:"https://api.locize.io/languages/{{projectId}}",addPath:"https://api.locize.io/missing/{{projectId}}/{{version}}/{{lng}}/{{ns}}",updatePath:"https://api.locize.io/update/{{projectId}}/{{version}}/{{lng}}/{{ns}}",referenceLng:"en",crossDomain:!0,setContentTypeJSON:!1,version:"latest",pull:!1,private:!1,whitelistThreshold:.9}}function l(t){return x.call(T.call(arguments,1),function(e){if(e)for(var n in e)void 0===t[n]&&(t[n]=e[n])}),t}function p(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function f(){return{order:["querystring","cookie","localStorage","navigator","htmlTag"],lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"]}}function d(t,e,n){var o;return function(){var i=this,r=arguments,a=function(){o=null,n||t.apply(i,r)},s=n&&!o;clearTimeout(o),o=setTimeout(a,e),s&&t.apply(i,r)}}function h(t,e,n){var o=t;return e.forEach(function(t){var e=new RegExp("{{"+t+"}}","g");o=o.replace(e,n[t])}),o}function g(t,e,n,o,i){try{var r=new(XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");r.open(o?"POST":"GET",t,1),e.crossDomain||r.setRequestHeader("X-Requested-With","XMLHttpRequest"),e.authorize&&e.apiKey&&r.setRequestHeader("Authorization",e.apiKey),(o||e.setContentTypeJSON)&&r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){r.readyState>3&&n&&n(r.responseText,r)},r.send(JSON.stringify(o))}catch(t){window.console&&console.log(t)}}function v(){return{lastUsedPath:"https://api.locize.io/used/{{projectId}}/{{version}}/{{lng}}/{{ns}}",referenceLng:"en",crossDomain:!0,setContentTypeJSON:!1,version:"latest",debounceSubmit:9e4}}function y(t){return null==t?"":""+t}function b(t,e,n){for(var o=void 0,i=void 0;o=X.exec(t);)i=o[1].trim(),"string"!=typeof i&&(i=y(i)),i||(i=""),i=function(t){return t.replace(/\$/g,"$$$$")}(i),t=t.replace(o[0],e[i]||i),X.lastIndex=0;return t}function k(t){return t}function m(t){return!0}function w(t){if(t.indexOf("-")<0)return t;var e=["NB-NO","NN-NO","nb-NO","nn-NO","nb-no","nn-no"],n=t.split("-");return e.indexOf(t)>-1?n[1].toLowerCase():n[0]}var L=new RegExp("{{(.+?)}}","g"),j=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},O=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),I=function(){function e(t,n,o){s(this,e),t&&t.projectId?this.init(null,t,{},n):this.init(null,n,{},o),this.type="backend"}return O(e,[{key:"init",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=this,i=(arguments[2],arguments[3]);this.options=j({},c(),this.options,n),this.options.pull&&console.warn("deprecated: pull will be removed in future versions and should be replaced with locize private versions"),"function"==typeof i&&this.getOptions(function(t,e){if(t)return i(t);o.options.referenceLng=n.referenceLng||e.referenceLng||o.options.referenceLng,i(null,e)}),this.queuedWrites={},this.debouncedProcess=t(this.process,1e4)}},{key:"getLanguages",value:function(t){var e=a(this.options.getLanguagesPath,{projectId:this.options.projectId});this.loadUrl(e,{},t)}},{key:"getOptions",value:function(t){var e=this;this.getLanguages(function(n,o){if(n)return t(n);var i=Object.keys(o);if(!i.length)return t(new Error("was unable to load languages via API"));var r=i.reduce(function(t,e){return o[e].isReferenceLanguage&&(t=e),t},""),a=i.reduce(function(t,n){var i=o[n];return i.translated[e.options.version]&&i.translated[e.options.version]>=e.options.whitelistThreshold&&t.push(n),t},[]),s=i.reduce(function(t,e){return e.indexOf("-")>-1||t},!1);t(null,{fallbackLng:r,referenceLng:r,whitelist:a,load:s?"all":"languageOnly"})})}},{key:"read",value:function(t,e,n){var o=void 0,i={};this.options.private?(o=a(this.options.privatePath,{lng:t,ns:e,projectId:this.options.projectId,version:this.options.version}),i={authorize:!0}):this.options.pull?(o=a(this.options.pullPath,{lng:t,ns:e,projectId:this.options.projectId,version:this.options.version}),i={authorize:!0}):o=a(this.options.loadPath,{lng:t,ns:e,projectId:this.options.projectId,version:this.options.version}),this.loadUrl(o,i,n)}},{key:"loadUrl",value:function(t,e,n){u(t,j({},this.options,e),function(e,o){if(o.status>=500&&o.status<600)return n("failed loading "+t,!0);if(o.status>=400&&o.status<500)return n("failed loading "+t,!1);var i=void 0,r=void 0;try{i=JSON.parse(e)}catch(e){r="failed parsing "+t+" to json"}if(r)return n(r,!1);n(null,i)})}},{key:"create",value:function(t,e,n,o,i,r){var a=this;i||(i=function(){}),"string"==typeof t&&(t=[t]),t.forEach(function(t){t===a.options.referenceLng&&a.queue.call(a,a.options.referenceLng,e,n,o,i,r)})}},{key:"update",value:function(t,e,n,o,i,r){var a=this;i||(i=function(){}),r||(r={}),"string"==typeof t&&(t=[t]),r.isUpdate=!0,t.forEach(function(t){t===a.options.referenceLng&&a.queue.call(a,a.options.referenceLng,e,n,o,i,r)})}},{key:"write",value:function(t,e){var o=this;if(!i(this.queuedWrites,["locks",t,e])){var r=a(this.options.addPath,{lng:t,ns:e,projectId:this.options.projectId,version:this.options.version}),s=a(this.options.updatePath,{lng:t,ns:e,projectId:this.options.projectId,version:this.options.version}),c=i(this.queuedWrites,[t,e]);if(n(this.queuedWrites,[t,e],[]),c.length){n(this.queuedWrites,["locks",t,e],!0);var l=!1,p=!1,f={},d={};c.forEach(function(t){var e=t.options&&t.options.tDescription?{value:t.fallbackValue||"",context:{text:t.options.tDescription}}:t.fallbackValue||"";t.options&&t.options.isUpdate?(p||(p=!0),d[t.key]=e):(l||(l=!0),f[t.key]=e)});var h=0;l&&h++,p&&h++;var g=function(){--h||(n(o.queuedWrites,["locks",t,e],!1),c.forEach(function(t){t.callback&&t.callback()}),o.debouncedProcess(t,e))};h||g(),l&&u(r,j({authorize:!0},this.options),function(t,e){g()},f),p&&u(s,j({authorize:!0},this.options),function(t,e){g()},d)}}}},{key:"process",value:function(){var t=this;Object.keys(this.queuedWrites).forEach(function(e){"locks"!==e&&Object.keys(t.queuedWrites[e]).forEach(function(n){t.queuedWrites[e][n].length&&t.write(e,n)})})}},{key:"queue",value:function(t,e,n,i,r,a){o(this.queuedWrites,[t,e],{key:n,fallbackValue:i||"",callback:r,options:a}),this.debouncedProcess()}}]),e}();I.type="backend";var S=[],x=S.forEach,T=S.slice,P={create:function(t,e,n,o){var i=void 0;if(n){var r=new Date;r.setTime(r.getTime()+60*n*1e3),i="; expires="+r.toGMTString()}else i="";o=o?"domain="+o+";":"",document.cookie=t+"="+e+i+";"+o+"path=/"},read:function(t){for(var e=t+"=",n=document.cookie.split(";"),o=0;o<n.length;o++){for(var i=n[o];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(e))return i.substring(e.length,i.length)}return null},remove:function(t){this.create(t,"",-1)}},q={name:"cookie",lookup:function(t){var e=void 0;if(t.lookupCookie&&"undefined"!=typeof document){var n=P.read(t.lookupCookie);n&&(e=n)}return e},cacheUserLanguage:function(t,e){e.lookupCookie&&"undefined"!=typeof document&&P.create(e.lookupCookie,t,e.cookieMinutes,e.cookieDomain)}},E={name:"querystring",lookup:function(t){var e=void 0;if("undefined"!=typeof window)for(var n=window.location.search.substring(1),o=n.split("&"),i=0;i<o.length;i++){var r=o[i].indexOf("=");if(r>0){var a=o[i].substring(0,r);a===t.lookupQuerystring&&(e=o[i].substring(r+1))}}return e}},z=void 0;try{z="undefined"!==window&&null!==window.localStorage;window.localStorage.setItem("i18next.translate.boo","foo"),window.localStorage.removeItem("i18next.translate.boo")}catch(t){z=!1}var D={name:"localStorage",lookup:function(t){var e=void 0;if(t.lookupLocalStorage&&z){var n=window.localStorage.getItem(t.lookupLocalStorage);n&&(e=n)}return e},cacheUserLanguage:function(t,e){e.lookupLocalStorage&&z&&window.localStorage.setItem(e.lookupLocalStorage,t)}},C={name:"navigator",lookup:function(t){var e=[];if("undefined"!=typeof navigator){if(navigator.languages)for(var n=0;n<navigator.languages.length;n++)e.push(navigator.languages[n]);navigator.userLanguage&&e.push(navigator.userLanguage),navigator.language&&e.push(navigator.language)}return e.length>0?e:void 0}},R={name:"htmlTag",lookup:function(t){var e=void 0,n=t.htmlTag||("undefined"!=typeof document?document.documentElement:null);return n&&"function"==typeof n.getAttribute&&(e=n.getAttribute("lang")),e}},U={name:"path",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var n=window.location.pathname.match(/\/([a-zA-Z-]*)/g);n instanceof Array&&(e="number"==typeof t.lookupFromUrlIndex?n[t.lookupFromPathIndex].replace("/",""):n[0].replace("/",""))}return e}},N={name:"subdomain",lookup:function(t){var e=void 0;if("undefined"!=typeof window){var n=window.location.pathname.match(/(?:http[s]*\:\/\/)*(.*?)\.(?=[^\/]*\..{2,5})/gi);n instanceof Array&&(e="number"==typeof t.lookupFromSubdomainIndex?n[t.lookupFromSubdomainIndex].replace("http://","").replace("https://","").replace(".",""):n[0].replace("http://","").replace("https://","").replace(".",""))}return e}},W=function(){function t(t,e){for(var n=0;n<e.length;n++){var o=e[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}return function(e,n,o){return n&&t(e.prototype,n),o&&t(e,o),e}}(),A=function(){function t(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};p(this,t),this.type="languageDetector",this.detectors={},this.init(e,n)}return W(t,[{key:"init",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.services=t,this.options=l(e,this.options||{},f()),this.i18nOptions=n,this.addDetector(q),this.addDetector(E),this.addDetector(D),this.addDetector(C),this.addDetector(R),this.addDetector(U),this.addDetector(N)}},{key:"addDetector",value:function(t){this.detectors[t.name]=t}},{key:"detect",value:function(t){var e=this;t||(t=this.options.order);var n=[];t.forEach(function(t){if(e.detectors[t]){var o=e.detectors[t].lookup(e.options);o&&"string"==typeof o&&(o=[o]),o&&(n=n.concat(o))}});var o=void 0;if(n.forEach(function(t){if(!o){var n=e.services.languageUtils.formatLanguageCode(t);e.services.languageUtils.isWhitelisted(n)&&(o=n)}}),!o){var i=this.i18nOptions.fallbackLng;"string"==typeof i&&(i=[i]),i||(i=[]),o="[object Array]"===Object.prototype.toString.apply(i)?i[0]:i[0]||i.default&&i.default[0]}return o}},{key:"cacheUserLanguage",value:function(t,e){var n=this;e||(e=this.options.caches),e&&(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(t)>-1||e.forEach(function(e){n.detectors[e]&&n.detectors[e].cacheUserLanguage(t,n.options)}))}}]),t}();A.type="languageDetector";var H=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(t[o]=n[o])}return t},M={init:function(t){var e=t.t&&"function"==typeof t.t;this.options=e?H({},v(),this.options,t.options.locizeLastUsed):H({},v(),this.options,t),this.submitting=null,this.pending={},this.done={},this.submit=d(this.submit,this.options.debounceSubmit),e&&this.interceptI18next(t)},interceptI18next:function(t){var e=this,n=t.services.resourceStore.getResource;t.services.resourceStore.getResource=function(o,i,r,a){return r&&e.used(i,r),n.call(t.services.resourceStore,o,i,r,a)}},used:function(t,e){var n=this;["pending","done"].forEach(function(o){n.done[t]&&n.done[t][e]||(n[o][t]||(n[o][t]={}),n[o][t][e]=!0)}),this.submit()},submit:function(){var t=this;if(this.submitting)return this.submit();this.submitting=this.pending,this.pending={};var e=Object.keys(this.submitting),n=e.length,o=function(){--n||(t.submitting=null)};e.forEach(function(e){var n=Object.keys(t.submitting[e]),i=h(t.options.lastUsedPath,["projectId","version","lng","ns"],H({},t.options,{lng:t.options.referenceLng,ns:e}));n.length?g(i,H({authorize:!0},t.options),function(t,e){o()},n):o()})}};M.type="3rdParty";var X=new RegExp("{{(.+?)}}","g"),$={interpolator:{interpolate:b},languageUtils:{formatLanguageCode:k,isWhitelisted:m}};return{init:function(t){return this.options=t,this.backend=new I($,t),this.detector=new A($,t),this.lng=t.lng||this.detector.detect(),M.init(t),this},getLanguage:function(t,e){var n=this;"function"==typeof t&&(e=t,t=this.lng),t||(t=this.lng);var o=function(t,e){return t[e]&&t[e].translated[n.options.version||"latest"]>=(n.options.loadIfTranslatedOver||1)};return this.getLanguages(function(i,r){return o(r,t)?e(null,t):o(r,w(t))?e(null,w(t)):void e(null,n.options.fallbackLng||Object.keys(r)[0])}),this},getLanguages:function(t){var e=this;return this.publishedLngs?t(null,this.publishedLngs):this.backend.getLanguages(function(n,o){n||(e.publishedLngs=o),t(null,o)}),this},load:function(t,e,n){var o=this;return"function"==typeof e&&(n=e,e=null),this.getLanguage(e,function(e,i){o.backend.read(i,t,function(t,e){return n(t,e,i)})}),this},add:function(t,e,n,o,i){var r={};return"function"==typeof o?i=o:"string"==typeof o&&(r.tDescription=o),this.backend.create(this.options.referenceLng,t,e,n,i,r),this},update:function(t,e,n,o,i){var r={isUpdate:!0};return"function"==typeof o?i=o:"string"==typeof o&&(r.tDescription=o),this.backend.create(this.options.referenceLng,t,e,n,i,r),this},used:function(t,e){M.used(t,e)}}});

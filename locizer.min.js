!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).locizer=t()}(this,(function(){"use strict";function e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function o(e,t,o){return t&&n(e.prototype,t),o&&n(e,o),e}function i(e,t,n){var o;return function(){var i=this,r=arguments,s=function(){o=null,n||e.apply(i,r)},a=n&&!o;clearTimeout(o),o=setTimeout(s,t),a&&e.apply(i,r)}}function r(e,t,n){function o(e){return e&&e.indexOf("###")>-1?e.replace(/###/g,"."):e}for(var i="string"!=typeof t?[].concat(t):t.split(".");i.length>1;){if(!e)return{};var r=o(i.shift());!e[r]&&n&&(e[r]=new n),e=e[r]}return e?{obj:e,k:o(i.shift())}:{}}function s(e,t,n){var o=r(e,t,Object);o.obj[o.k]=n}function a(e,t){var n=r(e,t),o=n.obj,i=n.k;if(o)return o[i]}var c=new RegExp("{{(.+?)}}","g");function u(e,t,n){var o,i,r;for(;o=c.exec(e);)"string"!=typeof(i=o[1].trim())&&(i=null==(r=i)?"":""+r),i||(i=""),i=i.replace(/\$/g,"$$$$"),e=e.replace(o[0],t[i]||i),c.lastIndex=0;return e}function l(e,t){return t.reduce((function(t,n){if(t)return t;if(!e||!e[n]||"string"!=typeof e[n]||!e[n].toLowerCase()===n.toLowerCase()){var o='i18next-locize-backend :: got "'.concat(e[n],'" in options for ').concat(n," which is invalid.");return console.warn(o),o}return!1}),!1)}function p(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function d(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?p(Object(o),!0).forEach((function(n){e(t,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):p(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function f(e,t,n,o,i){try{var r=new(XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");r.open(o?"POST":"GET",e,1),t.crossDomain||r.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.authorize&&t.apiKey&&r.setRequestHeader("Authorization",t.apiKey),(o||t.setContentTypeJSON)&&r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){r.readyState>3&&n&&n(r.responseText,r)},r.send(JSON.stringify(o))}catch(e){"undefined"!=typeof window&&window.console&&console.log(e)}}var h=function(){function e(n,o,i){t(this,e),n&&n.projectId?this.init(null,n,{},o):this.init(null,o,{},i),this.type="backend"}return o(e,[{key:"init",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2?arguments[2]:void 0,r=arguments.length>3?arguments[3]:void 0;this.options=d({},{loadPath:"https://api.locize.app/{{projectId}}/{{version}}/{{lng}}/{{ns}}",privatePath:"https://api.locize.app/private/{{projectId}}/{{version}}/{{lng}}/{{ns}}",getLanguagesPath:"https://api.locize.app/languages/{{projectId}}",addPath:"https://api.locize.app/missing/{{projectId}}/{{version}}/{{lng}}/{{ns}}",updatePath:"https://api.locize.app/update/{{projectId}}/{{version}}/{{lng}}/{{ns}}",referenceLng:"en",crossDomain:!0,setContentTypeJSON:!1,version:"latest",private:!1,whitelistThreshold:.9,failLoadingOnEmptyJSON:!1,allowedAddOrUpdateHosts:["localhost"],onSaved:!1},{},this.options,{},n),this.services=e,this.options.pull&&console.warn('The pull API was removed use "private: true" option instead: https://docs.locize.com/integration/api#fetch-private-namespace-resources');var s="undefined"!=typeof window&&window.location&&window.location.hostname;s?(this.isAddOrUpdateAllowed="function"==typeof this.options.allowedAddOrUpdateHosts?this.options.allowedAddOrUpdateHosts(s):this.options.allowedAddOrUpdateHosts.indexOf(s)>-1,o.saveMissing&&!this.isAddOrUpdateAllowed&&e&&e.logger&&e.logger.warn("function"==typeof this.options.allowedAddOrUpdateHosts?'locize-backend: will not save missings because allowedAddOrUpdateHosts returned false for the host "'.concat(s,'".'):'locize-backend: will not save missings because the host "'.concat(s,'" was not in the list of allowedAddOrUpdateHosts: ').concat(this.options.allowedAddOrUpdateHosts.join(", ")," (matches need to be exact)."))):this.isAddOrUpdateAllowed=!0,"function"==typeof r&&this.getOptions((function(e,o){if(e)return r(e);t.options.referenceLng=n.referenceLng||o.referenceLng||t.options.referenceLng,r(null,o)})),this.queuedWrites={},this.debouncedProcess=i(this.process,1e4)}},{key:"getLanguages",value:function(e){var t=l(this.options,["projectId"]);if(t)return e(new Error(t));var n=u(this.options.getLanguagesPath,{projectId:this.options.projectId});this.loadUrl(n,{},e)}},{key:"getOptions",value:function(e){var t=this;this.getLanguages((function(n,o){if(n)return e(n);var i=Object.keys(o);if(!i.length)return e(new Error("was unable to load languages via API"));var r=i.reduce((function(e,t){return o[t].isReferenceLanguage&&(e=t),e}),""),s=i.reduce((function(e,n){var i=o[n];return i.translated[t.options.version]&&i.translated[t.options.version]>=t.options.whitelistThreshold&&e.push(n),e}),[]),a=i.reduce((function(e,t){return t.indexOf("-")>-1||e}),!1);e(null,{fallbackLng:r,referenceLng:r,whitelist:s,load:a?"all":"languageOnly"})}))}},{key:"read",value:function(e,t,n){var o,i={};if(this.options.private){var r=l(this.options,["projectId","version","apiKey"]);if(r)return n(new Error(r),!1);o=u(this.options.privatePath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),i={authorize:!0}}else{var s=l(this.options,["projectId","version"]);if(s)return n(new Error(s),!1);o=u(this.options.loadPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version})}this.loadUrl(o,i,n)}},{key:"loadUrl",value:function(e,t,n){var o=this;f(e,d({},this.options,{},t),(function(t,i){if(408===i.status||400===i.status)return n("failed loading "+e,!0);if(i.status>=500&&i.status<600)return n("failed loading "+e,!0);if(i.status>=400&&i.status<500)return n("failed loading "+e,!1);var r,s;try{r=JSON.parse(t)}catch(t){s="failed parsing "+e+" to json"}return s?n(s,!1):o.options.failLoadingOnEmptyJSON&&!Object.keys(r).length?n("loaded result empty for "+e,!1):void n(null,r)}))}},{key:"create",value:function(e,t,n,o,i,r){var s=this;i||(i=function(){});var a=l(this.options,["projectId","version","apiKey","referenceLng"]);return a?i(new Error(a)):this.isAddOrUpdateAllowed?("string"==typeof e&&(e=[e]),e.filter((function(e){return e===s.options.referenceLng})).length<1&&this.services&&this.services.logger&&this.services.logger.warn('locize-backend: will not save missings because the reference language "'.concat(this.options.referenceLng,'" was not in the list of to save languages: ').concat(e.join(", ")," (open your site in the reference language to save missings).")),void e.forEach((function(e){e===s.options.referenceLng&&s.queue.call(s,s.options.referenceLng,t,n,o,i,r)}))):i("host is not allowed to create key.")}},{key:"update",value:function(e,t,n,o,i,r){var s=this;i||(i=function(){});var a=l(this.options,["projectId","version","apiKey","referenceLng"]);return a?i(new Error(a)):this.isAddOrUpdateAllowed?(r||(r={}),"string"==typeof e&&(e=[e]),r.isUpdate=!0,void e.forEach((function(e){e===s.options.referenceLng&&s.queue.call(s,s.options.referenceLng,t,n,o,i,r)}))):i("host is not allowed to update key.")}},{key:"write",value:function(e,t){var n=this;if(!a(this.queuedWrites,["locks",e,t])){var o=u(this.options.addPath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),i=u(this.options.updatePath,{lng:e,ns:t,projectId:this.options.projectId,version:this.options.version}),r=a(this.queuedWrites,[e,t]);if(s(this.queuedWrites,[e,t],[]),r.length){s(this.queuedWrites,["locks",e,t],!0);var c=!1,l=!1,p={},h={};r.forEach((function(e){var t=e.options&&e.options.tDescription?{value:e.fallbackValue||"",context:{text:e.options.tDescription}}:e.fallbackValue||"";e.options&&e.options.isUpdate?(l||(l=!0),h[e.key]=t):(c||(c=!0),p[e.key]=t)}));var g=0;c&&g++,l&&g++;var v=function(){--g||(s(n.queuedWrites,["locks",e,t],!1),r.forEach((function(e){e.callback&&e.callback()})),n.options.onSaved&&n.options.onSaved(e,t),n.debouncedProcess(e,t))};g||v(),c&&f(o,d({},{authorize:!0},{},this.options),(function(e,t){v()}),p),l&&f(i,d({},{authorize:!0},{},this.options),(function(e,t){v()}),h)}}}},{key:"process",value:function(){var e=this;Object.keys(this.queuedWrites).forEach((function(t){"locks"!==t&&Object.keys(e.queuedWrites[t]).forEach((function(n){e.queuedWrites[t][n].length&&e.write(t,n)}))}))}},{key:"queue",value:function(e,t,n,o,i,s){!function(e,t,n,o){var i=r(e,t,Object),s=i.obj,a=i.k;s[a]=s[a]||[],o&&(s[a]=s[a].concat(n)),o||s[a].push(n)}(this.queuedWrites,[e,t],{key:n,fallbackValue:o||"",callback:i,options:s}),this.debouncedProcess()}}]),e}();h.type="backend";var g=[],v=g.forEach,y=g.slice;function b(e){return v.call(y.call(arguments,1),(function(t){if(t)for(var n in t)void 0===e[n]&&(e[n]=t[n])})),e}var w,k=function(e,t,n,o){var i;if(n){var r=new Date;r.setTime(r.getTime()+60*n*1e3),i="; expires="+r.toGMTString()}else i="";o=o?"domain="+o+";":"",document.cookie=e+"="+t+i+";"+o+"path=/"},m=function(e){for(var t=e+"=",n=document.cookie.split(";"),o=0;o<n.length;o++){for(var i=n[o];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null},O={name:"cookie",lookup:function(e){var t;if(e.lookupCookie&&"undefined"!=typeof document){var n=m(e.lookupCookie);n&&(t=n)}return t},cacheUserLanguage:function(e,t){t.lookupCookie&&"undefined"!=typeof document&&k(t.lookupCookie,e,t.cookieMinutes,t.cookieDomain)}},j={name:"querystring",lookup:function(e){var t;if("undefined"!=typeof window)for(var n=window.location.search.substring(1).split("&"),o=0;o<n.length;o++){var i=n[o].indexOf("=");if(i>0)n[o].substring(0,i)===e.lookupQuerystring&&(t=n[o].substring(i+1))}return t}};try{w="undefined"!==window&&null!==window.localStorage;window.localStorage.setItem("i18next.translate.boo","foo"),window.localStorage.removeItem("i18next.translate.boo")}catch(e){w=!1}var L={name:"localStorage",lookup:function(e){var t;if(e.lookupLocalStorage&&w){var n=window.localStorage.getItem(e.lookupLocalStorage);n&&(t=n)}return t},cacheUserLanguage:function(e,t){t.lookupLocalStorage&&w&&window.localStorage.setItem(t.lookupLocalStorage,e)}},P={name:"navigator",lookup:function(e){var t=[];if("undefined"!=typeof navigator){if(navigator.languages)for(var n=0;n<navigator.languages.length;n++)t.push(navigator.languages[n]);navigator.userLanguage&&t.push(navigator.userLanguage),navigator.language&&t.push(navigator.language)}return t.length>0?t:void 0}},S={name:"htmlTag",lookup:function(e){var t,n=e.htmlTag||("undefined"!=typeof document?document.documentElement:null);return n&&"function"==typeof n.getAttribute&&(t=n.getAttribute("lang")),t}},x={name:"path",lookup:function(e){var t;if("undefined"!=typeof window){var n=window.location.pathname.match(/\/([a-zA-Z-]*)/g);if(n instanceof Array)if("number"==typeof e.lookupFromPathIndex){if("string"!=typeof n[e.lookupFromPathIndex])return;t=n[e.lookupFromPathIndex].replace("/","")}else t=n[0].replace("/","")}return t}},I={name:"subdomain",lookup:function(e){var t;if("undefined"!=typeof window){var n=window.location.href.match(/(?:http[s]*\:\/\/)*(.*?)\.(?=[^\/]*\..{2,5})/gi);n instanceof Array&&(t="number"==typeof e.lookupFromSubdomainIndex?n[e.lookupFromSubdomainIndex].replace("http://","").replace("https://","").replace(".",""):n[0].replace("http://","").replace("https://","").replace(".",""))}return t}};var A=function(){function e(n){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t(this,e),this.type="languageDetector",this.detectors={},this.init(n,o)}return o(e,[{key:"init",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.services=e,this.options=b(t,this.options||{},{order:["querystring","cookie","localStorage","navigator","htmlTag"],lookupQuerystring:"lng",lookupCookie:"i18next",lookupLocalStorage:"i18nextLng",caches:["localStorage"],excludeCacheFor:["cimode"],checkWhitelist:!0}),this.options.lookupFromUrlIndex&&(this.options.lookupFromPathIndex=this.options.lookupFromUrlIndex),this.i18nOptions=n,this.addDetector(O),this.addDetector(j),this.addDetector(L),this.addDetector(P),this.addDetector(S),this.addDetector(x),this.addDetector(I)}},{key:"addDetector",value:function(e){this.detectors[e.name]=e}},{key:"detect",value:function(e){var t=this;e||(e=this.options.order);var n,o=[];if(e.forEach((function(e){if(t.detectors[e]){var n=t.detectors[e].lookup(t.options);n&&"string"==typeof n&&(n=[n]),n&&(o=o.concat(n))}})),o.forEach((function(e){if(!n){var o=t.services.languageUtils.formatLanguageCode(e);t.options.checkWhitelist&&!t.services.languageUtils.isWhitelisted(o)||(n=o)}})),!n){var i=this.i18nOptions.fallbackLng;"string"==typeof i&&(i=[i]),i||(i=[]),n="[object Array]"===Object.prototype.toString.apply(i)?i[0]:i[0]||i.default&&i.default[0]}return n}},{key:"cacheUserLanguage",value:function(e,t){var n=this;t||(t=this.options.caches),t&&(this.options.excludeCacheFor&&this.options.excludeCacheFor.indexOf(e)>-1||t.forEach((function(t){n.detectors[t]&&n.detectors[t].cacheUserLanguage(e,n.options)})))}}]),e}();function E(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function U(t){for(var n=1;n<arguments.length;n++){var o=null!=arguments[n]?arguments[n]:{};n%2?E(Object(o),!0).forEach((function(n){e(t,n,o[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):E(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}A.type="languageDetector";var T={init:function(e){var t=e.t&&"function"==typeof e.t;this.options=U({},{lastUsedPath:"https://api.locize.app/used/{{projectId}}/{{version}}/{{lng}}/{{ns}}",referenceLng:"en",crossDomain:!0,setContentTypeJSON:!1,version:"latest",debounceSubmit:9e4,allowedHosts:["localhost"]},{},this.options,{},t?e.options.locizeLastUsed:e);var n,o,i,r,s=window.location&&window.location.hostname;this.isAllowed=!s||this.options.allowedHosts.indexOf(s)>-1,this.submitting=null,this.pending={},this.done={},this.submit=(n=this.submit,o=this.options.debounceSubmit,function(){var e=this,t=arguments,s=function(){r=null,i||n.apply(e,t)},a=i&&!r;clearTimeout(r),r=setTimeout(s,o),a&&n.apply(e,t)}),t&&this.interceptI18next(e)},interceptI18next:function(e){var t=this,n=e.services.resourceStore.getResource;e.services.resourceStore.getResource=function(o,i,r,s){return r&&t.used(i,r),n.call(e.services.resourceStore,o,i,r,s)}},used:function(e,t){var n=this;["pending","done"].forEach((function(o){n.done[e]&&n.done[e][t]||(n[o][e]||(n[o][e]={}),n[o][e][t]=!0)})),this.submit()},submit:function(){var e=this;if(this.isAllowed){if(this.submitting)return this.submit();var t,n=(t=this.options,["projectId","version","apiKey","referenceLng"].reduce((function(e,n){if(e)return e;if(!t||!t[n]||"string"!=typeof t[n]||!t[n].toLowerCase()===n.toLowerCase()){var o='i18next-lastused :: got "'.concat(t[n],'" in options for ').concat(n," which is invalid.");return console.warn(o),o}return!1}),!1));if(n)return callback(new Error(n));this.submitting=this.pending,this.pending={};var o=Object.keys(this.submitting),i=o.length,r=function(){--i||(e.submitting=null)};o.forEach((function(t){var n=Object.keys(e.submitting[t]),o=function(e,t,n){var o=e;return t.forEach((function(e){var t=new RegExp("{{".concat(e,"}}"),"g");o=o.replace(t,n[e])})),o}(e.options.lastUsedPath,["projectId","version","lng","ns"],U({},e.options,{lng:e.options.referenceLng,ns:t}));n.length?function(e,t,n,o,i){try{var r=new(XMLHttpRequest||ActiveXObject)("MSXML2.XMLHTTP.3.0");r.open(o?"POST":"GET",e,1),t.crossDomain||r.setRequestHeader("X-Requested-With","XMLHttpRequest"),t.authorize&&t.apiKey&&r.setRequestHeader("Authorization",t.apiKey),(o||t.setContentTypeJSON)&&r.setRequestHeader("Content-type","application/json"),r.onreadystatechange=function(){r.readyState>3&&n&&n(r.responseText,r)},r.send(JSON.stringify(o))}catch(e){window.console&&window.console.log(e)}}(o,U({},{authorize:!0},{},e.options),(function(e,t){r()}),n):r()}))}},type:"3rdParty"},D=new RegExp("{{(.+?)}}","g");function q(e){if(e.indexOf("-")<0)return e;var t=e.split("-");return["NB-NO","NN-NO","nb-NO","nn-NO","nb-no","nn-no"].indexOf(e)>-1?t[1].toLowerCase():t[0]}var z={interpolator:{interpolate:function(e,t,n){for(var o,i,r;o=D.exec(e);)"string"!=typeof(i=o[1].trim())&&(i=null==(r=i)?"":""+r),i||(i=""),i=i.replace(/\$/g,"$$$$"),e=e.replace(o[0],t[i]||i),D.lastIndex=0;return e}},languageUtils:{formatLanguageCode:function(e){return e},isWhitelisted:function(e){return!0}}};return{init:function(e){return this.options=e,this.backend=new h(z,e),this.detector=new A(z,e),this.lng=e.lng||this.detector.detect(),T.init(e),this},getLanguage:function(e,t){var n=this;"function"==typeof e&&(t=e,e=this.lng),e||(e=this.lng);var o=function(e,t){return e[t]&&e[t].translated[n.options.version||"latest"]>=(n.options.loadIfTranslatedOver||1)};return this.getLanguages((function(i,r){return o(r,e)?t(null,e):o(r,q(e))?t(null,q(e)):void t(null,n.options.fallbackLng||Object.keys(r)[0])})),this},getLanguages:function(e){var t=this;return this.publishedLngs?e(null,this.publishedLngs):this.backend.getLanguages((function(n,o){n||(t.publishedLngs=o),e(null,o)})),this},load:function(e,t,n){var o=this;return"function"==typeof t&&(n=t,t=null),this.getLanguage(t,(function(t,i){o.backend.read(i,e,(function(e,t){return n(e,t,i)}))})),this},add:function(e,t,n,o,i){var r={};return"function"==typeof o?i=o:"string"==typeof o&&(r.tDescription=o),this.backend.create(this.options.referenceLng,e,t,n,i,r),this},update:function(e,t,n,o,i){var r={isUpdate:!0};return"function"==typeof o?i=o:"string"==typeof o&&(r.tDescription=o),this.backend.create(this.options.referenceLng,e,t,n,i,r),this},used:function(e,t){T.used(e,t)}}}));
